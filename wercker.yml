box: fedora:23

dev:
    steps:
        - script:
            name: install gcc and make
            code: yum -y install gcc make
        - script:
            name: compile project
            code: make
        - internal/shell

build:
    steps:
        - script:
            name: install build dependencies
            code: yum -y install gcc make rpmdevtools
        - script:
            name: build rpm package
            code: |
                BUILD_NAME="${WERCKER_APPLICATION_NAME}-${WERCKER_GIT_COMMIT}"
                ARCH=`rpmbuild -E '%_arch'`
                RPMDIR=`rpmbuild -E '%_rpmdir'`
                mkdir -p /tmp/"$BUILD_NAME"
                cp -rf * /tmp/"$BUILD_NAME"
                cd /tmp/"$BUILD_NAME"
                tar -cvf $BUILD_NAME".tar "$BUILD_NAME"
                rpmbuild -D "%git_commit ${WERCKER_GIT_COMMIT}" -tb "${BUILD_NAME}.tar"
                cp "${RPMDIR}/${ARCH}/${BUILD_NAME}-1.${ARCH}.rpm" "$WERCKER_OUTPUT_DIR"


deploy:
    packagecloud:
        - script:
            name: install package_cloud client
            code: |
                yum -y install ruby
                gem install package_cloud
        - script:
            name: push to packagecloud
            code: |
                echo "{\"url\":\"https://packagecloud.io\",\"token\":\"${PACKAGECLOUD_API_TOKEN}\"}" > .packagecloud
                for rpm in *.rpm ; do LANG=en_US.utf8 package_cloud push --config=.packagecloud "$PACKAGECLOUD_REPO" "$rpm" ; done